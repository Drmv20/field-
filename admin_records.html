{% extends "base.html" %}
{% block title %}Admin â€¢ Records{% endblock %}

{% block sidebar_content %}
<ul class="nav flex-column">
    <li class="nav-item mb-2">
        <a href="{{ url_for('admin_dashboard') }}" class="nav-link text-white">
    <i class="bi bi-house"></i> Dashboard
</a>
    </li>
    <li class="nav-item mb-2">
        <a href="{{ url_for('admin_students') }}" class="nav-link text-white">
            <i class="fas fa-users me-2"></i> Students
        </a>
    </li>
    <li class="nav-item mb-2">
        <a class="nav-link text-white" data-bs-toggle="collapse" href="#attendanceMenu">
            <i class="fas fa-calendar-check me-2"></i> Attendance
        </a>
        <div class="collapse" id="attendanceMenu">
            <ul class="nav flex-column ps-4">
                <li class="nav-item">
                    <a href="{{ url_for('admin_attendance') }}" class="nav-link text-white">View Attendance</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('download_attendance') }}" class="nav-link text-white">Export</a>
                </li>
            </ul>
        </div>
    </li>
    <li class="nav-item mb-2">
        <a class="nav-link text-white active" data-bs-toggle="collapse" href="#reportMenu">
            <i class="fas fa-chart-bar me-2"></i> Reports
        </a>
        <div class="collapse show" id="reportMenu">
            <ul class="nav flex-column ps-4">
                <li class="nav-item">
                    <a href="#" class="nav-link text-white">Generate Report</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin_records') }}" class="nav-link text-white active">View Reports</a>
                </li>
            </ul>
        </div>
    </li>
    <li class="nav-item mt-auto border-top pt-3">
        <a href="{{ url_for('logout') }}" class="nav-link text-danger">
            <i class="fas fa-sign-out-alt me-2"></i> Logout
        </a>
    </li>
</ul>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-primary">Student Attendance Records</h1>
    <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown">
            <i class="fas fa-file-export me-2"></i>Export
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('export_records', period='daily') }}">Daily Report</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_records', period='weekly') }}">Weekly Report</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_records', period='monthly') }}">Monthly Report</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_records', period='yearly') }}">Yearly Report</a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_records', period='custom') }}">Custom Range</a></li>
        </ul>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" action="{{ url_for('admin_records') }}" class="row g-3">
            <div class="col-md-3">
                <label for="student_id" class="form-label">Student ID</label>
                <input type="text" class="form-control" id="student_id" name="student_id" value="{{ request.args.get('student_id', '') }}">
            </div>
            <div class="col-md-3">
                <label for="period" class="form-label">Time Period</label>
                <select class="form-select" id="period" name="period">
                    <option value="daily" {% if request.args.get('period') == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if request.args.get('period') == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if request.args.get('period') == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="yearly" {% if request.args.get('period') == 'yearly' %}selected{% endif %}>Yearly</option>
                    <option value="custom" {% if request.args.get('period') == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            <div class="col-md-3" id="dateField">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" value="{{ request.args.get('date', '') }}">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        {% if records %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.student.student_id }}</td>
                        <td>{{ record.student.name }}</td>
                        <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ record.time_in.strftime('%H:%M:%S') if record.time_in else 'N/A' }}</td>
                        <td>{{ record.time_out.strftime('%H:%M:%S') if record.time_out else 'N/A' }}</td>
                        <td>
                            {% if record.time_in and record.time_out %}
                                {{ (record.time_out - record.time_in).seconds // 3600 }}h 
                                {{ ((record.time_out - record.time_in).seconds % 3600) // 60 }}m
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{% if record.status == 'present' %}success{% else %}warning{% endif %}">
                                {{ record.status|capitalize }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <p class="text-muted">No attendance records found for the selected filters</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Show/hide date field based on period selection
    document.getElementById('period').addEventListener('change', function() {
        const dateField = document.getElementById('dateField');
        if (this.value === 'custom') {
            dateField.innerHTML = `
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
                <label for="end_date" class="form-label mt-2">End Date</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            `;
        } else {
            dateField.innerHTML = `
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" value="{{ request.args.get('date', '') }}">
            `;
        }
    });

    // Initialize the correct view on page load
    document.addEventListener('DOMContentLoaded', function() {
        const periodSelect = document.getElementById('period');
        if (periodSelect) {
            const event = new Event('change');
            periodSelect.dispatchEvent(event);
        }
    });
</script>
{% endblock %}